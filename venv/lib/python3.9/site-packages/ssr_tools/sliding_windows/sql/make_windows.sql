DROP TABLE IF EXISTS {output_schema}.{short_name};
CREATE TABLE {output_schema}.{short_name} (
    short_window_id SERIAL PRIMARY KEY,
    geom GEOMETRY(LINESTRING, {network_srid}),
    {dissolve_fields_add}
);

INSERT INTO {output_schema}.{short_name}(
    geom,
    {dissolve_fields_list})
SELECT
    ST_LineMerge(
        ST_LineSubstring(
            geom,
            {step_length} * n / _length,
            CASE
                WHEN {step_length} * (n + 1) < _length
                THEN {step_length} * (n + 1) / _length
            ELSE 1
            END
        )
    ) AS geom,
    {dissolve_fields_list}
FROM {output_schema}.dissolved_network AS t
    CROSS JOIN generate_series(0, {max_iter}) AS n
WHERE ({step_length} * n) / _length < 1
UNION
SELECT
    ST_LineMerge(geom),
    {dissolve_fields_list}
FROM {output_schema}.dissolved_network
WHERE _length < {step_length}
;

CREATE INDEX IF NOT EXISTS sidx_{short_name}_geom ON {output_schema}.{short_name} USING GIST(geom);
ANALYSE {output_schema}.{short_name}(geom);

DROP TABLE IF EXISTS {output_schema}.{sliding_name};
CREATE TABLE {output_schema}.{sliding_name}(
    id SERIAL PRIMARY KEY,
    geom GEOMETRY(LINESTRING, {network_srid}),
    {dissolve_fields_add}
);

INSERT INTO {output_schema}.{sliding_name}(
    geom,
    {dissolve_fields_list})
SELECT
    ST_LineMerge(
        ST_LineSubstring(
            geom,
            {step_length} * n / _length,
            CASE
                WHEN ({window_length} + ({step_length} * n)) < _length
                THEN ({window_length} + ({step_length} * n)) / _length
            ELSE 1
    END)) AS geom,
    {dissolve_fields_list}
FROM {output_schema}.dissolved_network AS t
    CROSS JOIN generate_series(0, {max_iter}) AS n
WHERE n < 1 + CEILING((_length - {window_length})/{step_length})
UNION
SELECT
    ST_LineMerge(geom),
    {dissolve_fields_list}
FROM {output_schema}.dissolved_network
WHERE _length < {window_length}
;

CREATE INDEX IF NOT EXISTS sidx_{sliding_name}_geom ON {output_schema}.{sliding_name} USING GIST(geom);
ANALYSE {output_schema}.{sliding_name}(geom);