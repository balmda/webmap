DROP TABLE IF EXISTS {output_schema}.{crash_name};
CREATE TABLE {output_schema}.{crash_name} AS (
    SELECT *
    FROM {crash_schema}.{crash_table}
);

ALTER TABLE {output_schema}.{crash_name} ADD PRIMARY KEY({crash_table_pkey});

ALTER TABLE {output_schema}.{crash_name}
    ADD IF NOT EXISTS {crash_table_mode_col}_{crash_table_sev_col} TEXT,
    ADD IF NOT EXISTS exclude_flag BOOLEAN,
    ADD IF NOT EXISTS geom_flag BOOLEAN,
    ADD IF NOT EXISTS type_flag BOOLEAN,
    ADD IF NOT EXISTS sev_flag BOOLEAN
    {where_flag_add}
    {year_flag_add}
    {exclude_mode_col_add}
    {exclude_sev_col_add}
;

UPDATE {output_schema}.{crash_name} t1
SET {crash_table_mode_col}_{crash_table_sev_col} = REPLACE(LOWER(t1.{crash_table_mode_col}||'_'||t1.{crash_table_sev_col}), ' ', '_'),
    geom_flag = CASE
            WHEN t1.{crash_table_geom} IS NULL
            THEN TRUE
            ELSE FALSE
        END,
    type_flag = CASE
            WHEN t1.{crash_table_mode_col} IS NULL
            THEN TRUE
            ELSE FALSE
        END,
    sev_flag = CASE
            WHEN t1.{crash_table_sev_col} IS NULL
            THEN TRUE
            ELSE FALSE
        END
    {where_flag_code}
    {year_flag_code}
    {exclude_mode_col_code}
    {exclude_sev_col_code}
{from_if}
;

UPDATE {output_schema}.{crash_name}
SET exclude_flag = CASE
        WHEN geom_flag OR type_flag OR sev_flag {where_flag} {year_flag} {exclude_mode_col} {exclude_sev_col} 
        THEN TRUE
        ELSE FALSE
END;

CREATE INDEX IF NOT EXISTS sidx_crash_{crash_table_geom} ON {output_schema}.{crash_name} USING GIST({crash_table_geom});
ANALYSE {output_schema}.{crash_name}({crash_table_geom});
CREATE INDEX IF NOT EXISTS idx_{crash_name}_{crash_table_mode_col}_{crash_table_sev_col} ON {output_schema}.{crash_name}({crash_table_mode_col}_{crash_table_sev_col});
ANALYSE {output_schema}.{crash_name}({crash_table_mode_col}_{crash_table_sev_col});

DROP TABLE IF EXISTS {output_schema}.{exclude_name};

CREATE TABLE {output_schema}.{exclude_name} AS (
    SELECT *
    FROM {output_schema}.{crash_name}
    WHERE exclude_flag
);

ALTER TABLE {output_schema}.{exclude_name} ADD PRIMARY KEY({crash_table_pkey});

DELETE FROM {output_schema}.{crash_name}
WHERE exclude_flag
;