--add columns and nullify
ALTER TABLE {road_schema}.{road}
    ADD COLUMN IF NOT EXISTS {int_from} INT, 
    ADD COLUMN IF NOT EXISTS {int_to} INT 
;

UPDATE {road_schema}.{road}
SET {int_from} = NULL,
    {int_to} = NULL
;

-- from ints
DROP TABLE IF EXISTS tmp_from_ints;
CREATE TEMP TABLE tmp_from_ints AS 
    SELECT 
        DISTINCT ON (r.{road_pkey})
            r.{road_pkey} AS road_id,
            i.{int_pkey} AS int_id
        FROM
            {road_schema}.{road} r,
            {int_schema}.{int_table} i
        WHERE ST_DWithin(r.{road_geom}, i.{int_geom}, {tolerance})
        AND ST_DWithin(ST_StartPoint(r.{road_geom}), i.{int_geom},{tolerance})
        ORDER BY
            road_id,
            ST_Distance(ST_StartPoint(r.{road_geom}),i.{int_geom}) ASC
;

-- to ints
DROP TABLE IF EXISTS tmp_to_ints;
CREATE TEMP TABLE tmp_to_ints AS 
    SELECT 
        DISTINCT ON (r.{road_pkey})
            r.{road_pkey} AS road_id,
            i.{int_pkey} AS int_id
        FROM
            {road_schema}.{road} r,
            {int_schema}.{int_table} i
        WHERE ST_DWithin(r.{road_geom}, i.{int_geom}, {tolerance})
        AND ST_DWithin(ST_EndPoint(r.{road_geom}), i.{int_geom},{tolerance})
        ORDER BY
            road_id,
            ST_Distance(ST_EndPoint(r.{road_geom}),i.{int_geom}) ASC
;

-- join to from int_it back to roads
DROP TABLE IF EXISTS tmp_to_from_ints; 
CREATE TEMP TABLE tmp_to_from_ints AS 
    SELECT 
        r.{road_pkey} as road_id,
        tmp_from_ints.int_id AS from_id, 
        tmp_to_ints.int_id AS to_id
    FROM {road_schema}.{road} r
        LEFT JOIN tmp_from_ints
            ON r.{road_pkey} = tmp_from_ints.road_id
        LEFT JOIN tmp_to_ints
            ON r.{road_pkey} = tmp_to_ints.road_id
;

-- bring back to road table
UPDATE {road_schema}.{road} r
SET {int_from} = tmp_to_from_ints.from_id,
    {int_to} = tmp_to_from_ints.to_id
FROM tmp_to_from_ints 
WHERE r.{road_pkey} = tmp_to_from_ints.road_id
;