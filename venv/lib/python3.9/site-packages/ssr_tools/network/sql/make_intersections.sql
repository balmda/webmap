-- create a temp table that store the start and end point for each segment
DROP TABLE IF EXISTS tmp_all_ints;
CREATE TEMP TABLE tmp_all_ints AS 
    SELECT 
        DISTINCT ST_StartPoint({road_geom}) AS geom
    FROM {road_schema}.{road}

    UNION

    SELECT 
        DISTINCT ST_EndPoint({road_geom})
    FROM {road_schema}.{road}
;

DROP TABLE IF EXISTS tmp_ints; 
CREATE TEMP TABLE tmp_ints AS 
    SELECT
        ST_Centroid(
            ST_CollectionExtract(
                unnest(
                    ST_ClusterWithin(tmp_all_ints.geom, {tolerance})
                ),
            1)
        ) geom
    FROM tmp_all_ints
;

DROP TABLE IF EXISTS {int_out_schema}.{int_table};
CREATE TABLE {int_out_schema}.{int_table} (
    {int_pkey} SERIAL PRIMARY KEY,
    {int_geom} geometry(point,{int_srid})
);

INSERT INTO {int_out_schema}.{int_table} ({int_geom})
SELECT tmp_ints.geom
FROM tmp_ints 
;

CREATE INDEX {s_index} ON {int_out_schema}.{int_table} USING GIST ({int_geom});