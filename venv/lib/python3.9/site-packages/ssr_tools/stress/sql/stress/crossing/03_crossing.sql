DROP TABLE IF EXISTS scratch.tmp_stress;
SELECT DISTINCT ON (attrs.id)
    attrs.id,
    attrs.control,
    attrs.lanes,
    attrs.speed,
    attrs.island,
    lts.stress, 
    attrs.aadt,
    attrs.oneway,
    lts.condition,
    lts.criteria
INTO TABLE scratch.tmp_stress
FROM
    scratch.tmp_cross_streets AS attrs,
    {cross_lts_schema}.{cross_lts_table} lts
WHERE
    COALESCE(attrs.control,'none') = COALESCE(lts.control,'none')
    AND attrs.lanes <= lts.lanes
    AND attrs.speed <= lts.speed
    AND attrs.aadt <= lts.aadt
    AND COALESCE(attrs.oneway, FALSE) = COALESCE(lts.oneway,FALSE)
    AND COALESCE(attrs.island,FALSE) = COALESCE(lts.island,FALSE)
ORDER BY
    attrs.id,
    lts.stress ASC
;

INSERT INTO {out_schema}.{out_table} (
    {id_column},
    {geom},
    legs,
    control,
    lanes,
    speed,
    island,
    aadt,
    oneway,
    condition,
    criteria,
    stress
)
SELECT
    tmp_stress.id,
    {in_table}.geom,
    tmp_intcount.legs,
    tmp_stress.control,
    tmp_stress.lanes,
    tmp_stress.speed,
    tmp_stress.island,
    tmp_stress.aadt,
    tmp_stress.oneway,
    tmp_stress.condition,
    tmp_stress.criteria,
    CASE WHEN tmp_intcount.legs = 2 THEN -9 ELSE tmp_stress.stress END
FROM
    {in_schema}.{in_table}
    LEFT JOIN scratch.tmp_stress tmp_stress
        ON tmp_stress.id = {in_table}.{id_column}
    LEFT JOIN scratch.tmp_intcount tmp_intcount
        ON tmp_intcount.id = {in_table}.{id_column}
;
 