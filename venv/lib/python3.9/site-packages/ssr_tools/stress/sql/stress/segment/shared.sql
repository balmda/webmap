-----------------------------------------------
-- mixed traffic with all available data,
-- also bike lanes of substandard width
-- (uses tables in DB, based on Furth 2017 with
-- some adjustments)
-----------------------------------------------

-- #reading given and assumed road characteristics;
DROP TABLE IF EXISTS pg_temp.tmp_attrs;

-- two way
CREATE TEMP TABLE tmp_attrs AS (
    SELECT
        {id_column}::INTEGER AS id,
        {fclass_column}::TEXT AS fclass,
        COALESCE({lanes},{assumed_lanes})::INTEGER AS lanes,
        CASE
            WHEN COALESCE({lanes},{assumed_lanes})::INTEGER > 0 THEN TRUE
            ELSE COALESCE({centerline},{assumed_centerline})::BOOLEAN
            END AS marked_centerline,
        COALESCE({speed},{assumed_speed})::INTEGER AS speed,
        COALESCE({aadt},{assumed_aadt})::INTEGER AS effective_aadt
    FROM
        {in_schema}.{in_table}
    WHERE
        ({shared})
        AND {filter}
        AND {twoway}
);

ALTER TABLE pg_temp.tmp_attrs ADD COLUMN stress_pkey SERIAL PRIMARY KEY; 

CREATE INDEX IF NOT EXISTS idx_tmp_attrs_stress_pkey
ON pg_temp.tmp_attrs
USING BTREE (stress_pkey);

CREATE INDEX IF NOT EXISTS idx_tmp_attrs_stress_id
ON pg_temp.tmp_attrs
USING BTREE (id);

ANALYZE pg_temp.tmp_attrs;

 
-- one way
INSERT INTO pg_temp.tmp_attrs
SELECT
    {id_column}::INTEGER,
    {fclass_column}::TEXT AS fclass,
    COALESCE({lanes},{assumed_lanes})::INTEGER,
    CASE
        WHEN COALESCE({lanes},{assumed_lanes})::INTEGER > 0 THEN TRUE
        ELSE COALESCE({centerline},{assumed_centerline})::BOOLEAN
        END AS marked_centerline,
    COALESCE({speed},{assumed_speed})::INTEGER,
    (COALESCE({aadt},{assumed_aadt})*1.5)::INTEGER
FROM
    {in_schema}.{in_table}
WHERE
    ({shared})
    AND {filter}
    AND {oneway}
;

ANALYZE pg_temp.tmp_attrs;


-- #comparing against LTS tables;
DROP TABLE IF EXISTS pg_temp.tmp_stress;
CREATE TEMP TABLE pg_temp.tmp_stress AS (
    SELECT DISTINCT ON (tmp_attrs.id)
        tmp_attrs.id,
        lts.stress
    FROM
        pg_temp.tmp_attrs,
        {shared_lts_schema}.{shared_lts_table} lts
    WHERE
        tmp_attrs.lanes <= lts.lanes
        AND tmp_attrs.marked_centerline::BOOLEAN = lts.marked_centerline::BOOLEAN
        AND tmp_attrs.speed <= lts.speed
        AND tmp_attrs.effective_aadt <= lts.effective_aadt
    ORDER BY
        tmp_attrs.id,
        (tmp_attrs.lanes = lts.lanes) DESC, --ensures that we give priority to an exact match
        (tmp_attrs.speed = lts.speed) DESC, --ensures that we give priority to an exact match
        lts.stress ASC
);

-- SELECT 
--     lts.stress
-- FROM
--     generated.stress_shared_ssrc_v1 lts
-- WHERE
--     4 <= lts.lanes
--     AND lts.marked_centerline
--     AND 40 <= lts.speed
--     AND 17000<= lts.effective_aadt
-- ORDER BY
--     lts.stress ASC
-- ;
CREATE INDEX tidx_tmp_stress_id ON pg_temp.tmp_stress (id); 
ANALYZE pg_temp.tmp_stress;

INSERT INTO {out_schema}.{out_table} (
    {id_column},
    {fclass_column},
    {geom},
    lanes,
    marked_centerline,
    speed,
    effective_aadt,
    stress
)
SELECT
    tmp_attrs.id,
    tmp_attrs.fclass,
    {in_table}.geom,
    tmp_attrs.lanes,
    tmp_attrs.marked_centerline,
    tmp_attrs.speed,
    tmp_attrs.effective_aadt,
    tmp_stress.stress
FROM
    pg_temp.tmp_attrs,
    {in_schema}.{in_table},
    pg_temp.tmp_stress
WHERE
    tmp_attrs.id = {in_table}.{id_column}
    AND tmp_attrs.id = tmp_stress.id
;
