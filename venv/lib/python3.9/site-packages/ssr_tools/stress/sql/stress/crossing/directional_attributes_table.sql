DROP TABLE IF EXISTS scratch.tmp_alldirs;
CREATE TABLE scratch.tmp_alldirs (
    id INTEGER,
    lanes INTEGER,
    speed INTEGER, 
    aadt INTEGER, 
    oneway BOOLEAN
);

-- id, speed, lanes for oneway and twoway separately
-- into pdg_temp.tmp_alldirs
{data_insert}

DROP TABLE IF EXISTS scratch.tmp_combineddirs;
SELECT DISTINCT ON (tmp_alldirs.id)
    tmp_alldirs.id,
    o.{geom} AS geom,
    bna_MultiEndPoint(o.{geom}) AS forward_pt,
    ST_MakeLine(ST_PointN(o.{geom},-2),ST_EndPoint(o.{geom})) AS forward_ln,
    bna_MultiStartPoint(o.{geom}) AS backward_pt,
    ST_MakeLine(ST_PointN(o.{geom},2),ST_StartPoint(o.{geom})) AS backward_ln,
    SUM(tmp_alldirs.lanes) AS lanes,
    MAX(tmp_alldirs.speed) AS speed, 
    MAX(tmp_alldirs.aadt) AS aadt, 
    MAX(tmp_alldirs.oneway::INT)::BOOLEAN AS oneway
INTO scratch.tmp_combineddirs
FROM
    scratch.tmp_alldirs tmp_alldirs,
    {in_schema}.{in_table} o
WHERE
    tmp_alldirs.id = o.{id_column}
GROUP BY
    tmp_alldirs.id,
    o.{geom}
ORDER BY
    tmp_alldirs.id
;

CREATE INDEX tidx_tmp_combineddirs_id ON scratch.tmp_alldirs (id);
CREATE INDEX sidx_tmp_combineddirs ON scratch.tmp_combineddirs USING GIST (geom);
CREATE INDEX sidx_tmp_combineddirs_fwd ON scratch.tmp_combineddirs USING GIST (forward_pt);
CREATE INDEX sidx_tmp_combineddirs_bwd ON scratch.tmp_combineddirs USING GIST (backward_pt);
ANALYZE scratch.tmp_combineddirs;
 